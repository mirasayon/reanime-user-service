generator client {
  provider               = "prisma-client"
  output                 = "../client"
  runtime                = "nodejs"
  moduleFormat           = "esm"
  generatedFileExtension = "ts"
  importFileExtension    = "ts"
  engineType             = "client"
}

datasource db {
  provider = "postgresql"
}

model UserAccount {
  id         String   @id @default(cuid())
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @updatedAt @db.Timestamptz
  /// Account role/type (e.g., COMMON, ADMIN).
  account_type AccountTypeEnum @default(COMMON)
  /// User email (nullable).
  email        String?         @unique
  /// Public visibility of the email.
  email_visibility EmailVisibilityEnum @default(HIDE)
  /// Unique username (no "@").
  username                String            @unique
  /// Related password record.
  password_data           AccountPassword?
  /// Is account activated by email.
  is_activated_with_email Boolean           @default(false)
  /// Email activation token/link (nullable).
  email_activation_link   String?
  /// Reports filed against this account.
  reports_to_this_account ReportToAccount[]
  /// Public profile (bio, avatar, etc.).
  profile                 UserProfile?
  /// Active and historical login sessions.
  login_sessions          LoginSession[]
  @@index([account_type])
  @@index([is_activated_with_email])
  @@index([email_activation_link])
}

/// Account password with hash and algorithm parameters.
model AccountPassword {
  id             String      @id @default(cuid())
  created_at     DateTime    @default(now()) @db.Timestamptz
  updated_at     DateTime    @updatedAt @db.Timestamptz
  /// Related account (cascade on delete).
  for_account    UserAccount @relation(fields: [for_account_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Owner account id.
  for_account_id String      @unique
  /// Password hash (base64).
  hash_base64    String
  /// Salt (base64).
  salt_base64    String
  /// Argon2 memory (bytes).
  memory                 Int
  /// Argon2 time cost (iterations).
  passes                 Int
  /// Argon2 parallelism (threads).
  parallelism            Int
  /// Output tag/hash length (bytes).
  tag_length             Int
  /// Needs rehash when params change.
  needs_rehash           Boolean @default(false)
  /// Hash algorithm version (1 = Argon2id).
  hash_algorithm_version Int     @default(1)
}
/// Persistent login sessions (remember-me).
model LoginSession {
  id                  String    @id @default(cuid())
  created_at          DateTime  @default(now()) @db.Timestamptz
  updated_at          DateTime  @updatedAt @db.Timestamptz
  /// Public token selector.
  selector            String    @unique
  /// Hash of the private validator.
  hashed_validator    String
  /// Validator algorithm version.
  validator_version   Int       @default(1)
  /// Expiration datetime.
  expires_at          DateTime  @db.Timestamptz
  /// Last used datetime.
  last_used_at        DateTime  @default(now()) @db.Timestamptz
  // Network / location
  /// IP address
  ip_address          String
  /// Country determined by IP (iso/name).
  ip_country          String?
  /// Region/state from IP.
  ip_region           String?
  /// City from IP.
  ip_city             String?
  /// When location was last updated.
  location_updated_at DateTime? @db.Timestamptz

  /// Request User-Agent.
  user_agent      String?
  /// Device type (console|desktop|mobile|...).
  device_type     String?
  /// Device model (if available).
  device_model    String?
  /// OS name.
  os              String?
  /// OS version.
  os_version      String?
  /// Browser name.
  browser         String?
  /// Browser version.
  browser_version String?
  /// Device fingerprint hash.
  device_hash     String?

  /// Account owning this session.
  by_account    UserAccount @relation(fields: [by_account_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Owner account id.
  by_account_id String

  @@index([by_account_id])
  @@index([ip_address])
  @@index([device_hash])
  @@index([ip_country, ip_region])
  @@index([expires_at])
}

/// Avatar image metadata.
model ProfileAvatarPicture {
  id                     String      @id @default(cuid())
  created_at             DateTime    @default(now()) @db.Timestamptz
  updated_at             DateTime    @updatedAt @db.Timestamptz
  /// MIME type (e.g., "image/webp").
  mime_type              String
  /// Relative storage path (directory).
  path_dirname           String
  /// Filename in storage.
  path_filename          String
  /// Original uploaded filename.
  original_name          String
  /// Profile owning this avatar (cascade on delete).
  by_profile             UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Owner profile id (1:1).
  by_profile_id          String      @unique
  /// Image width (px).
  width                  Int
  /// Image height (px).
  height                 Int
  /// File size (bytes).
  size_bytes             Int
  /// Hash algorithm version (e.g., 1 = sha3-512).
  hash_algorithm_version Int
  /// File hash (base64url).
  file_hash              String

  @@unique([path_dirname, path_filename])
}

/// Cover image metadata.
model ProfileCoverPicture {
  id                     String      @id @default(cuid())
  created_at             DateTime    @default(now()) @db.Timestamptz
  updated_at             DateTime    @updatedAt @db.Timestamptz
  /// MIME type.
  mime_type              String
  /// Relative storage path (directory).
  path_dirname           String
  /// Filename in storage.
  path_filename          String
  /// Original uploaded filename.
  original_name          String
  /// Profile owning this cover (cascade on delete).
  by_profile             UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Owner profile id (1:1).
  by_profile_id          String      @unique
  /// Image width (px).
  width                  Int
  /// Image height (px).
  height                 Int
  /// File size (bytes).
  size_bytes             Int
  /// Hash algorithm version.
  hash_algorithm_version Int
  /// File hash (base64url).
  file_hash              String

  @@unique([path_dirname, path_filename])
}

/// Public user profile â€” bio, nickname and privacy settings.
model UserProfile {
  id                   String                    @id @default(cuid())
  created_at           DateTime                  @default(now()) @db.Timestamptz
  updated_at           DateTime                  @updatedAt @db.Timestamptz
  /// Optional avatar.
  avatar               ProfileAvatarPicture?
  /// Optional cover.
  cover                ProfileCoverPicture? 
  bio  String? @db.VarChar(400)
  /// Related account (cascade on delete).
  by_account           UserAccount               @relation(fields: [by_account_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Related account id (unique).
  by_account_id        String                    @unique
  /// Public nickname.
  nickname             String?
  /// Reports related to comments by this profile.
  reports_to_comments  ReportToComment[]
  /// Reports related to replies by this profile.
  reports_to_replies   ReportToReplyForComment[]
  /// Reports against this profile/account.
  reports_to_accounts  ReportToAccount[]
  /// Birth date (date only).
  date_of_birth        DateTime?                 @db.Date
  /// Birthdate visibility.
  birthdate_visibility BirthdateVisibilityEnum   @default(NONE)
  /// Comments by this profile on anime.
  comments_to_animes   CommentForAnime[]
  /// Replies by this profile.
  replies_to_comment   ReplyForComment[]
  /// Votes on replies by others.
  votes_to_replies     VoteToReply[]
  /// Votes on comments.
  votes_to_comments    VoteToComment[]
  /// Gender info.
  gender               GenderEnum                @default(UNSPECIFIED)
  /// Freeform gender text.
  other_gender         String?                   @db.VarChar(32)
  /// Gender visibility.
  gender_visibility    GenderVisibilityEnum      @default(NONE)
  /// Votes on anime.
  votes_to_animes      VoteToAnime[]
  /// Anime ratings by this profile.
  anime_rates          AnimeRating[]
  /// Anime bookmarks by this profile.
  anime_bookmarks      AnimeBookmark[]
}

/// Anime rating by profile (1..10).
model AnimeRating {
  id                String      @id @default(cuid())
  created_at        DateTime    @default(now()) @db.Timestamptz
  updated_at        DateTime    @updatedAt @db.Timestamptz
  /// Profile who rated.
  by_profile        UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Rater profile id.
  by_profile_id     String
  /// External anime id.
  external_anime_id Int         @db.Integer
  /// Rating value (1..10).
  rating            Int

  @@unique([by_profile_id, external_anime_id])
  @@index([by_profile_id])
  @@index([external_anime_id])
  @@index([rating])
}

/// Anime bookmark with status (WATCHING, PLANNED, etc.).
model AnimeBookmark {
  id                String          @id @default(cuid())
  created_at        DateTime        @default(now()) @db.Timestamptz
  updated_at        DateTime        @updatedAt @db.Timestamptz
  /// Profile who bookmarked.
  by_profile        UserProfile     @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Owner profile id.
  by_profile_id     String
  /// External anime id.
  external_anime_id Int             @db.Integer
  /// Bookmark status.
  status            AnimeStatusEnum

  @@unique([by_profile_id, external_anime_id])
  @@index([by_profile_id])
  @@index([external_anime_id])
  @@index([status])
}

/// Like/dislike for anime (value = 1 or -1).
model VoteToAnime {
  id                String      @id @default(cuid())
  created_at        DateTime    @default(now()) @db.Timestamptz
  updated_at        DateTime    @updatedAt @db.Timestamptz
  /// Profile who voted.
  by_profile        UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  by_profile_id     String
  /// External anime id.
  external_anime_id Int         @db.Integer
  /// 1 = like, -1 = dislike.
  value             Int

  @@unique([by_profile_id, external_anime_id])
  @@index([by_profile_id])
  @@index([external_anime_id])
  @@index([value])
  @@index([external_anime_id, value])
}

/// Reply to a comment.
model ReplyForComment {
  id         String   @id @default(cuid())
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @updatedAt @db.Timestamptz

  /// Reply text (DB TEXT).
  content       String                    @db.Text
  /// Author profile.
  by_profile    UserProfile               @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  by_profile_id String
  /// Reports against this reply.
  reports       ReportToReplyForComment[]
  /// Is reply visible publicly.
  is_visible    Boolean                   @default(true)
  /// Comment this reply is for.
  to_comment    CommentForAnime           @relation(fields: [to_comment_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  to_comment_id String
  /// Votes for this reply.
  ratings       VoteToReply[]

  @@index([by_profile_id])
  @@index([to_comment_id])
}

/// Comment on an anime.
model CommentForAnime {
  id                      String            @id @default(cuid())
  created_at              DateTime          @default(now()) @db.Timestamptz
  updated_at              DateTime          @updatedAt @db.Timestamptz
  /// Comment text (DB TEXT).
  content                 String            @db.Text
  /// Is comment visible.
  is_visible              Boolean           @default(true)
  /// Reports against this comment.
  reports_to_this_comment ReportToComment[]
  /// Author profile.
  by_profile              UserProfile       @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  by_profile_id           String
  /// External anime id.
  external_anime_id       Int               @db.Integer
  /// Votes for this comment.
  ratings                 VoteToComment[]
  /// Replies to this comment.
  replies_to_this_comment ReplyForComment[]

  @@index([external_anime_id])
}

/// Vote on a comment (1 = like, -1 = dislike).
model VoteToComment {
  id         String   @id @default(cuid())
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @updatedAt @db.Timestamptz

  /// Profile who voted.
  by_profile    UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  by_profile_id String

  /// Comment voted for.
  to_comment    CommentForAnime @relation(fields: [to_comment_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  to_comment_id String
  /// 1 = like, -1 = dislike.
  value         Int

  @@unique([by_profile_id, to_comment_id])
  @@index([to_comment_id])
  @@index([by_profile_id])
}

/// Vote on a reply (1 = like, -1 = dislike).
model VoteToReply {
  id         String   @id @default(cuid())
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @updatedAt @db.Timestamptz

  /// Profile who voted.
  by_profile    UserProfile     @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  by_profile_id String
  /// Reply voted for.
  to_reply      ReplyForComment @relation(fields: [to_reply_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  to_reply_id   String
  /// 1 = like, -1 = dislike.
  value         Int

  /// One vote per profile per reply.
  @@unique([by_profile_id, to_reply_id])
  @@index([to_reply_id])
  @@index([by_profile_id])
  @@index([value])
}

/// Report on a comment.
model ReportToComment {
  id            String      @id @default(cuid())
  created_at    DateTime    @default(now()) @db.Timestamptz
  updated_at    DateTime    @updatedAt @db.Timestamptz
  /// Reporter profile.
  by_profile    UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  by_profile_id String

  /// Comment reported.
  to_comment    CommentForAnime  @relation(fields: [to_comment_id], references: [id], onDelete: Cascade)
  to_comment_id String
  /// Reason (enum).
  reason        ReportReasonEnum
  /// Optional description.
  description   String?          @db.Text
  /// Show report in audit/history.
  is_visible    Boolean          @default(true)

  @@unique([by_profile_id, to_comment_id])
  @@index([to_comment_id])
  @@index([by_profile_id])
}

/// Report on a reply.
model ReportToReplyForComment {
  id         String   @id @default(cuid())
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @updatedAt @db.Timestamptz

  /// Reporter profile.
  by_profile    UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  by_profile_id String

  /// Reply reported.
  to_reply    ReplyForComment @relation(fields: [to_reply_id], references: [id], onDelete: Cascade)
  to_reply_id String

  /// Reason (enum).
  reason      ReportReasonEnum
  /// Optional description.
  description String?          @db.Text
  /// Show report in audit/history.
  is_visible  Boolean          @default(true)

  @@unique([by_profile_id, to_reply_id])
  @@index([to_reply_id])
  @@index([by_profile_id])
}

/// Report on an account/profile.
model ReportToAccount {
  id         String   @id @default(cuid())
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @updatedAt @db.Timestamptz

  /// Reporter profile.
  by_profile    UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  by_profile_id String

  /// Account reported.
  to_account    UserAccount      @relation(fields: [to_account_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  to_account_id String
  /// Reason (enum).
  reason        ReportReasonEnum
  /// Optional description.
  description   String?          @db.Text
  /// Show report in audit/history.
  is_visible    Boolean          @default(true)

  @@unique([by_profile_id, to_account_id])
  @@index([to_account_id])
  @@index([by_profile_id])
}

/// Enums

/// Birthdate visibility options.
enum BirthdateVisibilityEnum {
  NONE      // hide birthdate
  YEAR_ONLY // show only year
  FULL      // show full date
}

/// Email visibility.
enum EmailVisibilityEnum {
  SHOW
  HIDE
}

/// Gender visibility.
enum GenderVisibilityEnum {
  NONE
  PUBLIC
}

/// Gender options.
enum GenderEnum {
  MALE
  FEMALE
  OTHER
  UNSPECIFIED
}

/// Anime bookmark status.
enum AnimeStatusEnum {
  WATCHING
  ABANDONED
  PLANNED
  COMPLETED
}

/// Account types.
enum AccountTypeEnum {
  COMMON
  BANNED
  ADMIN
  DEVELOPER
  TESTER
}

/// Report reasons for moderation.
enum ReportReasonEnum {
  SPAM
  ADVERTISEMENT
  SCAM
  ABUSE
  HARASSMENT
  HATE_SPEECH
  VIOLENCE
  NUDITY
  PERSONAL_DATA_LEAK
  COPYRIGHT
  MISINFORMATION
  IMPERSONATION
  ILLEGAL_ACTIVITY
  TERRORISM
  OTHER
}