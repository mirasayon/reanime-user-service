generator client {
  provider               = "prisma-client"
  output                 = "../../src/databases/orm"
  runtime                = "nodejs"
  moduleFormat           = "esm"
  generatedFileExtension = "ts"
  importFileExtension    = "ts"
  engineType             = "client"
}

datasource db {
  provider = "postgresql"
}

/// User account. The central model representing an account in the system.
model UserAccount {
  /// Уникальный идентификатор аккаунта (cuid).
  id         String   @id @default(cuid())
  /// Время создания записи (в часовом поясе базы).
  created_at DateTime @default(now()) @db.Timestamptz
  /// Время последнего обновления записи (обновляется автоматически).
  updated_at DateTime @updatedAt @db.Timestamptz

  /// Роль / тип учетной записи аккаунта (COMMON, BANNED, ADMIN и т.д.). Используется для контроля прав доступа.
  account_type AccountTypeEnum @default(COMMON)
  /// Электронная почта пользователя. Может быть null — значит пользователь не указал почту.
  email        String?         @unique

  /// Видимость публичного адреса электронной почты для других пользователей.
  email_visibility EmailVisibilityEnum @default(HIDE)

  /// Уникальный логин (без символа "@"). Служит для публичного отображения и входа.
  username                String            @unique
  /// Связанная запись с хэшем пароля и параметрами алгоритма. Отдельная модель для безопасности и истории.
  password_data           AccountPassword?
  /// Флаг, подтверждён ли аккаунт по почте. Если false — некоторые функции могут быть недоступны.
  is_activated_with_email Boolean           @default(false)
  /// Токен/ссылка для активации по email. Если null — активация по почте недоступна.
  email_activation_link   String?
  /// Жалобы, поданные на этот аккаунт другими пользователями.
  reports_to_this_account ReportToAccount[]
  /// Публичный профиль, связанный с этим аккаунтом (имя, био, аватар и т.д.).
  profile                 UserProfile?
  /// Активные и исторические сессии входа для данного аккаунта.
  login_sessions          LoginSession[]

  @@index([account_type])
  @@index([is_activated_with_email])
  @@index([email_activation_link])
}

/// Пароль аккаунта. Хранит сам хэш, соль и параметры алгоритма (Argon2).
model AccountPassword {
  /// Уникальный идентификатор записи пароля.
  id             String      @id @default(cuid())
  /// Время создания записи.
  created_at     DateTime    @default(now()) @db.Timestamptz
  /// Время последнего обновления (например, при смене пароля).
  updated_at     DateTime    @updatedAt @db.Timestamptz
  /// Связанный аккаунт (отношение). При удалении аккаунта — каскадно удаляется пароль.
  for_account    UserAccount @relation(fields: [for_account_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди аккаунта, которому принадлежит этот пароль.
  for_account_id String      @unique
  /// Сам хэш пароля в base64 (результат Argon2 / другого KDF).
  hash_base64    String
  /// Используемая соль в base64 (для возможности миграции/верификации).
  salt_base64    String

  // -- Параметры для алгоритма Argon2 --
  /// Память в байтах, передаваемая в Argon2 (например 65536).
  memory                 Int
  /// Количество проходов/итераций (time cost) для Argon2.
  passes                 Int
  /// Параллелизм (количество потоков) для Argon2.
  parallelism            Int
  /// Длина итогового тега/хэша в байтах.
  tag_length             Int
  /// Флаг, указывающий, нужно ли перехешировать пароль при изменении параметров безопасности.
  needs_rehash           Boolean @default(false)
  /// Версия/код алгоритма хеширования. 1 = Argon2id (локальная конвенция).
  hash_algorithm_version Int     @default(1)
}

/// Сессии входа (persistent sessions / remember-me tokens).
model LoginSession {
  /// Уникальный идентификатор сессии.
  id                  String    @id @default(cuid())
  /// Время создания сессии.
  created_at          DateTime  @default(now()) @db.Timestamptz
  /// Время последнего обновления записи сессии.
  updated_at          DateTime  @updatedAt @db.Timestamptz
  /// Селектор (публичная часть токена), используется для быстрого поиска сессии.
  selector            String    @unique
  /// Хеш приватной части валидатора (HMAC-SHA-512(validator, SESSION_SECRET)). Храним хеш.
  hashed_validator    String
  /// Версия алгоритма валидатора. 1 = HMAC-SHA-512 (локальная конвенция).
  validator_version   Int       @default(1)
  /// Дата и время истечения сессии.
  expires_at          DateTime  @db.Timestamptz
  /// Дата последнего использования (для статистики и очистки старых сессий).
  last_used_at        DateTime  @default(now()) @db.Timestamptz
  // Network / location
  /// IP-адрес, с которого была создана/использовалась сессия (строка для IPv4/IPv6).
  ip_address          String
  /// ISO-код страны или название страны, определённое по IP.
  ip_country          String?
  /// Регион / штат, определённый по IP.
  ip_region           String?
  /// Город, определённый по IP.
  ip_city             String?
  /// Время последнего обновления данных геолокации для этой сессии.
  location_updated_at DateTime? @db.Timestamptz

  /// User-Agent заголовка запроса, полезно для анализа устройства.
  user_agent      String?
  /// Тип устройства (console | desktop | embedded | mobile | smarttv | tablet | wearable | xr).
  device_type     String?
  /// Модель устройства (если доступна).
  device_model    String?
  /// Название операционной системы.
  os              String?
  /// Версия операционной системы.
  os_version      String?
  /// Название браузера (если применимо).
  browser         String?
  /// Версия браузера.
  browser_version String?
  /// Хеш устройства для дедупликации (например hash(userAgent+os+browser+model+IP)).
  device_hash     String?

  /// Аккаунт, которому принадлежит сессия.
  by_account    UserAccount @relation(fields: [by_account_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди аккаунта владельца сессии.
  by_account_id String

  @@index([by_account_id])
  @@index([ip_address])
  @@index([device_hash])
  @@index([ip_country, ip_region])
  @@index([expires_at])
}

/// Изображение аватарки пользователя: путь, mime и метаданные.
model ProfileAvatarPicture {
  /// Уникальный идентификатор картинки.
  id                     String      @id @default(cuid())
  /// Дата добавления картинки.
  created_at             DateTime    @default(now()) @db.Timestamptz
  /// Дата последнего обновления метаданных.
  updated_at             DateTime    @updatedAt @db.Timestamptz
  /// MIME-тип файла (например "image/webp").
  mime_type              String
  /// Относительный путь к файлу в хранилище (без домена).
  path_dirname           String
  path_filename          String
  /// Оригинальное имя загруженного файла (для отображения/лога).
  original_name          String
  /// Профиль, которому принадлежит эта картинка. При удалении профиля — каскадно удаляется картинка.
  by_profile             UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди профиля-владельца картинки (уникально — 1:1 связь).
  by_profile_id          String      @unique
  /// Ширина изображения в пикселях.
  width                  Int
  /// Высота изображения в пикселях.
  height                 Int
  /// Размер файла в байтах.
  size_bytes             Int
  /// Версия алгоритма хеширования. 1 = Sha3-512 (локальная конвенция).
  hash_algorithm_version Int
  /// Хеш файла в base64url.
  file_hash              String

  @@unique([path_dirname, path_filename])
}

/// Изображение обложки профиля: путь, mime и метаданные.
model ProfileCoverPicture {
  id                     String      @id @default(cuid())
  created_at             DateTime    @default(now()) @db.Timestamptz
  updated_at             DateTime    @updatedAt @db.Timestamptz
  /// MIME-тип файла (например "image/webp").
  mime_type              String
  /// Относительный путь к файлу обложки.
  path_dirname           String
  path_filename          String
  /// Оригинальное имя файла.
  original_name          String
  /// Профиль, которому принадлежит обложка.
  by_profile             UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди профиля-владельца (уникально — 1:1 связь).
  by_profile_id          String      @unique
  /// Ширина в пикселях.
  width                  Int
  /// Высота в пикселя.
  height                 Int
  /// Размер файла в байтах.
  size_bytes             Int
  /// Версия алгоритма хеширования. 1 = Sha3-512 (локальная конвенция).
  hash_algorithm_version Int
  /// Хеш файла в base64url.
  file_hash              String

  @@unique([path_dirname, path_filename])
}

/// Публичный профиль пользователя — био, ник, настройки приватности и связи с аккаунтом.
model UserProfile {
  /// Уникальный идентификатор профиля.
  id                   String                    @id @default(cuid())
  /// Дата создания профиля.
  created_at           DateTime                  @default(now()) @db.Timestamptz
  /// Дата последнего обновления профиля.
  updated_at           DateTime                  @updatedAt @db.Timestamptz
  /// Связанная аватарка (опционально).
  avatar               ProfileAvatarPicture?
  /// Связанная обложка (опционально).
  cover                ProfileCoverPicture?
  /// Короткий текст о себе (биография), отображается на публичной странице.
  bio                  String?
  /// Аккаунт, которому принадлежит профиль. При удалении аккаунта профиль удаляется.
  by_account           UserAccount               @relation(fields: [by_account_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди связанного аккаунта (уникально).
  by_account_id        String                    @unique
  /// Публичный псевдоним / никнейм.
  nickname             String?
  /// Жалобы, связанные с комментариями этого профиля.
  reports_to_comments  ReportToComment[]
  /// Жалобы на ответы, сделанные этим профилем.
  reports_to_replies   ReportToReplyForComment[]
  /// Жалобы на аккаунт владельца этого профиля.
  reports_to_accounts  ReportToAccount[]
  /// Дата рождения (только дата, без времени).
  date_of_birth        DateTime?                 @db.Date
  /// Настройка видимости даты рождения для других пользователей.
  birthdate_visibility BirthdateVisibilityEnum   @default(NONE)
  /// Комментарии, оставленные этим профилем к аниме.
  comments_to_animes   CommentForAnime[]
  /// Ответы, оставленные этим профилем на комментарии.
  replies_to_comment   ReplyForComment[]
  /// Лайки/дизлайки, поставленные ответам другими пользователями.
  votes_to_replies     VoteToReply[]
  /// Лайки/дизлайки к комментариям.
  votes_to_comments    VoteToComment[]
  /// Информация о гендере профиля.
  gender               GenderEnum                @default(UNSPECIFIED)
  /// Текстовое поле для нетиповых описаний гендера.
  other_gender         String?
  /// Видимость информации о гендере для других пользователей.
  gender_visibility    GenderVisibilityEnum      @default(NONE)
  /// Лайки/дизлайки, поставленные аниме (предпочтения).
  votes_to_animes      VoteToAnime[]
  /// Оценки аниме (1..10), выставленные этим профилем.
  anime_rates          AnimeRating[]
  /// Закладки аниме, добавленные этим профилем.
  anime_bookmarks      AnimeBookmark[]
}

/// Оценка аниме профилем. Значение rating — от 1 до 10 (включительно).
model AnimeRating {
  id                String      @id @default(cuid())
  created_at        DateTime    @default(now()) @db.Timestamptz
  updated_at        DateTime    @updatedAt @db.Timestamptz
  /// Профиль, который поставил оценку.
  by_profile        UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди профиля, поставившего оценку.
  by_profile_id     String
  /// Внешний идентификатор аниме (например, из внешнего сервиса).
  external_anime_id Int         @db.Integer
  /// Значение оценки (int 1..10). Валидацию желательно выполнять в коде/ручных триггерах.
  rating            Int

  @@unique([by_profile_id, external_anime_id])
  @@index([by_profile_id])
  @@index([external_anime_id])
  @@index([rating])
}

/// Закладки аниме для профиля с указанием статуса (watching/planned/completed и т.д.).
model AnimeBookmark {
  id                String          @id @default(cuid())
  created_at        DateTime        @default(now()) @db.Timestamptz
  updated_at        DateTime        @updatedAt @db.Timestamptz
  /// Профиль, который добавил закладку.
  by_profile        UserProfile     @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди профиля-владельца закладки.
  by_profile_id     String
  /// Внешний идентификатор аниме.
  external_anime_id Int             @db.Integer
  /// Статус аниме в закладках (WATCHING, PLANNED и т.д.).
  status            AnimeStatusEnum

  @@unique([by_profile_id, external_anime_id])
  @@index([by_profile_id])
  @@index([external_anime_id])
  @@index([status])
}

/// Лайк/дизлайк к аниме (value = 1 или -1). Для агрегации и быстрых запросов.
model VoteToAnime {
  id                String      @id @default(cuid())
  created_at        DateTime    @default(now()) @db.Timestamptz
  updated_at        DateTime    @updatedAt @db.Timestamptz
  /// Профиль, который проголосовал.
  by_profile        UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди профиля-автора голоса.
  by_profile_id     String
  /// Внешний идентификатор аниме.
  external_anime_id Int         @db.Integer
  /// Значение: 1 = like, -1 = dislike. Валидацию на уровне приложения.
  value             Int

  @@unique([by_profile_id, external_anime_id])
  @@index([by_profile_id])
  @@index([external_anime_id])
  @@index([value])
  @@index([external_anime_id, value])
}

/// Ответ на комментарий: текст, автор, к какому комменту привязан и связанные рейтинги/жалобы.
model ReplyForComment {
  id         String   @id @default(cuid())
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @updatedAt @db.Timestamptz

  /// Текст ответа (без ограничения по длине; используется тип TEXT в БД).
  content       String                    @db.Text
  /// Профиль-автор ответа.
  by_profile    UserProfile               @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди профиля-автора.
  by_profile_id String
  /// Все жалобы, поданные на этот ответ.
  reports       ReportToReplyForComment[]
  /// Флаг видимости ответа для публичных страниц (false — скрыт).
  is_visible    Boolean                   @default(true)
  /// Комментарий, на который дан ответ.
  to_comment    CommentForAnime           @relation(fields: [to_comment_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди комментария, на который ответили.
  to_comment_id String
  /// Оценки (лайки/дизлайки) для этого ответа.
  ratings       VoteToReply[]

  @@index([by_profile_id])
  @@index([to_comment_id])
}

/// Комментарий к аниме: текст, автор, привязка к аниме, рейтинги и ответы.
model CommentForAnime {
  id                      String            @id @default(cuid())
  created_at              DateTime          @default(now()) @db.Timestamptz
  updated_at              DateTime          @updatedAt @db.Timestamptz
  /// Текст комментария (TEXT в БД).
  content                 String            @db.Text
  /// Видимость комментария для пользователей (модерация).
  is_visible              Boolean           @default(true)
  /// Жалобы, поданные на этот комментарий.
  reports_to_this_comment ReportToComment[]
  /// Профиль-автор комментария.
  by_profile              UserProfile       @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди профиля-автора.
  by_profile_id           String
  /// Внешний идентификатор аниме, к которому относится комментарий.
  external_anime_id       Int               @db.Integer
  /// Рейтинги (лайки/дизлайки) для этого комментария.
  ratings                 VoteToComment[]
  /// Ответы на этот комментарий.
  replies_to_this_comment ReplyForComment[]

  @@index([external_anime_id])
}

/// Лайк/дизлайк на комментарий.
model VoteToComment {
  id         String   @id @default(cuid())
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @updatedAt @db.Timestamptz

  /// Профиль, который проголосовал.
  by_profile    UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди профиля-голосующего.
  by_profile_id String

  /// Комментарий, за который отдали голос.
  to_comment    CommentForAnime @relation(fields: [to_comment_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди комментария.
  to_comment_id String
  /// Значение голоса: 1 = like, -1 = dislike.
  value         Int

  @@unique([by_profile_id, to_comment_id])
  @@index([to_comment_id])
  @@index([by_profile_id])
}

/// Лайк/дизлайк на ответ к комментарию.
model VoteToReply {
  id         String   @id @default(cuid())
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @updatedAt @db.Timestamptz

  /// Профиль, который проголосовал.
  by_profile    UserProfile     @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди профиля-голосующего.
  by_profile_id String
  /// Ответ, за который был отдан голос.
  to_reply      ReplyForComment @relation(fields: [to_reply_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди ответа.
  to_reply_id   String
  /// Значение голоса: 1 = like, -1 = dislike.
  value         Int

  @@unique([by_profile_id, to_reply_id]) // Одна оценка для одного ответа на комментарий
  @@index([to_reply_id])
  @@index([by_profile_id])
  @@index([value])
}

/// Жалоба на комментарий — кто, на какой комментарий и почему.
model ReportToComment {
  id            String      @id @default(cuid())
  created_at    DateTime    @default(now()) @db.Timestamptz
  updated_at    DateTime    @updatedAt @db.Timestamptz
  /// Профиль, подавший жалобу.
  by_profile    UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди профиля-жалобщика.
  by_profile_id String

  /// Комментарий, на который подана жалоба.
  to_comment    CommentForAnime  @relation(fields: [to_comment_id], references: [id], onDelete: Cascade)
  /// Айди комментария.
  to_comment_id String
  /// Причина жалобы (enum). Используется для модерации/фильтрации.
  reason        ReportReasonEnum
  /// Дополнительное пояснение (опционально), особенно если reason == OTHER.
  description   String?          @db.Text
  /// Флаг, показывать ли запись жалобы в публичной истории (обычно true для аудита).
  is_visible    Boolean          @default(true)

  // индексы / ограничения
  @@unique([by_profile_id, to_comment_id]) // предотвращает дубль-репорт от одного профиля
  @@index([to_comment_id]) // быстрый поиск по комментарию
  @@index([by_profile_id])
}

/// Жалоба на ответ на комментарий.
model ReportToReplyForComment {
  id         String   @id @default(cuid())
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @updatedAt @db.Timestamptz

  /// Профиль-жалобщик.
  by_profile    UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди профиля-жалобщика.
  by_profile_id String

  /// Ответ, на который подана жалоба.
  to_reply    ReplyForComment @relation(fields: [to_reply_id], references: [id], onDelete: Cascade)
  /// Айди ответа.
  to_reply_id String

  /// Причина жалобы (enum).
  reason      ReportReasonEnum
  /// Дополнительное описание (опционально).
  description String?          @db.Text
  /// Видимость записи жалобы для истории.
  is_visible  Boolean          @default(true)

  @@unique([by_profile_id, to_reply_id])
  @@index([to_reply_id])
  @@index([by_profile_id])
}

/// Жалоба на аккаунт (профиль), кто, на какой аккаунт и причина.
model ReportToAccount {
  id         String   @id @default(cuid())
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @updatedAt @db.Timestamptz

  /// Профиль, подавший жалобу.
  by_profile    UserProfile @relation(fields: [by_profile_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди профиля-жалобщика.
  by_profile_id String

  /// Аккаунт, на который пожаловались.
  to_account    UserAccount      @relation(fields: [to_account_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// Айди аккаунта-жертвы жалобы.
  to_account_id String
  /// Причина жалобы (enum).
  reason        ReportReasonEnum
  /// Дополнительное описание (опционально).
  description   String?          @db.Text
  /// Видимость записи жалобы в истории.
  is_visible    Boolean          @default(true)

  @@unique([by_profile_id, to_account_id])
  @@index([to_account_id])
  @@index([by_profile_id])
}

// -- Энумы (значения и описание для каждого варианта) --

/// Видимость даты рождения пользователя для других.
enum BirthdateVisibilityEnum {
  /// Полностью скрывать дату рождения от других пользователей.
  NONE
  /// Показывать только год рождения (год виден, день и месяц скрыты).
  YEAR_ONLY
  /// Показывать полную дату рождения (день, месяц, год).
  FULL
}

enum EmailVisibilityEnum {
  /// Показывать пользователю публичный адрес электронной почты.
  SHOW
  /// Не показывать публичный адрес электронной почты.
  HIDE
}

/// Видимость гендерной информации профиля.
enum GenderVisibilityEnum {
  /// Не показывать гендер публично.
  NONE
  /// Показывать гендер публично на странице профиля.
  PUBLIC
}

/// Гендер / пол профиля.
enum GenderEnum {
  /// Мужской пол.
  MALE
  /// Женский пол.
  FEMALE
  /// Для тех, кто не вписывается в бинарную систему — нейтральная опция.
  OTHER
  /// Значение по умолчанию, когда пользователь не указал пол.
  UNSPECIFIED
}

/// Статус аниме в закладках пользователя.
enum AnimeStatusEnum {
  /// Аниме, которое пользователь сейчас смотрит.
  WATCHING
  /// Аниме, которое пользователь забросил/перестал смотреть.
  ABANDONED
  /// Аниме, которое пользователь планирует посмотреть.
  PLANNED
  /// Аниме, которое пользователь досмотрел.
  COMPLETED
}

/// Типы аккаунтов и их семантика в системе.
enum AccountTypeEnum {
  /// Обычный пользователь с базовыми правами.
  COMMON
  /// Аккаунт, заблокированный/запрещённый (ограничен в действиях).
  BANNED
  /// Администратор с повышенными правами.
  ADMIN
  /// Разработчик (может иметь доступ к внутренним инструментам).
  DEVELOPER
  /// Тестовый аккаунт (может использоваться в QA/CI).
  TESTER
}

/// Причины жалоб — используемые категории для модерации.
enum ReportReasonEnum {
  /// Спам или массовые бессмысленные сообщения.
  SPAM
  /// Навязчивая реклама, коммерческие ссылки без разрешения.
  ADVERTISEMENT
  /// Мошенническая активность: скам, фишинг, выманивание денег.
  SCAM
  /// Общие нарушения правил платформы (универсальная категория).
  ABUSE
  /// Оскорбления, травля, целенаправленное преследование.
  HARASSMENT
  /// Разжигание ненависти или дискриминация по защищённым признакам.
  HATE_SPEECH
  /// Призывы к насилию, угрозы или поощрение вреда.
  VIOLENCE
  /// Контент с обнажением или нежелательной/неуместной сексуальной графикой.
  NUDITY
  /// Публикация персональных данных без согласия (doxing, утечки).
  PERSONAL_DATA_LEAK
  /// Нарушение авторских прав или публикация защищённого контента.
  COPYRIGHT
  /// Вводящая в заблуждение или заведомо ложная информация.
  MISINFORMATION
  /// Выдача себя за другое лицо или организацию (имперсонация).
  IMPERSONATION
  /// Пропаганда или инструкция по совершению незаконной деятельности.
  ILLEGAL_ACTIVITY
  /// Поддержка, пропаганда или организация терроризма / экстремизма.
  TERRORISM
  /// Другая причина, не покрытая перечисленными категориями.
  OTHER
}
